<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="theme-color" content="#fecd08" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            background: linear-gradient(135deg, #fecd08 10%, #49b95a 90%);
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: 100% 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-family: Arial, sans-serif;
        }

        .container {
            background-color: #252525;
            margin: 55px auto;
            padding: 20px;
            max-width: 1150px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        h2 {
            margin: 0;
        }

        .status {
            margin-top: 0;
            font-weight: normal;
            color: white;
        }

        .status.error {
            color: #ff6b6b;
        }

        .status.success {
            color: #7bd389;
        }

        .status.neutral {
            color: #ffffff;
        }

        #addBtn {
            font-size: 14px !important;
            max-width: 140px !important;
            border-radius: 15px !important;
            display: none;
            align-items: center;
            gap: 6px;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
            padding: 12px 10px;
            display: flex;
        }

        /* Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            background: #1f1f1f;
            border-radius: 6px;
            overflow: hidden;
        }

        .items-table th,
        .items-table td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 15px;
        }

        .items-table thead {
            background: rgba(255, 255, 255, 0.03);
            color: #dcdcdc;
            font-weight: 500;
            text-transform: none;
            font-size: 11px;
            letter-spacing: normal;
        }

        .item-name {
            color: #ffffff;
            /* name: bright */
            font-weight: 600;
        }

        .item-desc {
            color: #bfbfbf;
            /* slightly darker (less bright) than name */
            font-weight: 400;
            font-size: 13px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            /* center everything horizontally */
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            color: #fff;
            font-size: 14px;
        }

        .pagination button {
            background: #333;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .center {
            text-align: center;
        }

        .empty {
            padding: 18px;
            color: #d0d0d0;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
        }

        @media (max-width: 640px) {

            .items-table th,
            .items-table td {
                padding: 10px;
                font-size: 13px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Change your welcomeText element to a flex container -->
        <h1 id="welcomeText" style="display: flex; align-items: center; justify-content: center; gap: 10px;">Loading...
        </h1>
        <div id="statusMsg" class="status neutral" style="display: flex; align-items: center; gap: 12px;">
            <span id="statusText">Preparing...</span>
            <button id="addBtn">
                <img src="../images/plus.svg" alt="Add" style="width:15px;height:15px;">
                <span>Add an item</span>
            </button>

            <button id="editBtn"
                style="font-size:14px;max-width:140px;border-radius:15px;align-items:center;gap:6px;background-color:#555;color:white;border:none;cursor:pointer;padding:12px 10px;display:flex;opacity:0.5;pointer-events:none;">
                <img src="../images/pencil.svg" alt="Edit" style="width:15px;height:15px;">
                <span>Edit</span>
            </button>

            <button id="removeBtn"
                style="font-size:14px;max-width:140px;border-radius:15px;align-items:center;gap:6px;background-color:#555;color:white;border:none;cursor:pointer;padding:12px 10px;display:flex;opacity:0.5;pointer-events:none;">
                <img src="../images/trash.svg" alt="Remove" style="width:15px;height:15px;">
                <span>Delete</span>
            </button>

            <button id="logoutBtn"
                style="margin-left:auto; background-color:#FF3B30; color:white; border:none; padding:10px 20px; font-size:14px; border-radius:5px; cursor:pointer; display:flex; align-items:center; gap:6px;">
                Log out
            </button>
        </div>

        <div id="content">
            <!-- Table will be inserted here -->
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const statusMsg = document.getElementById('statusMsg');
        const content = document.getElementById('content');
        const brandLabel = document.getElementById('brandLabel');
        const welcomeText = document.getElementById('welcomeText');
        const addBtn = document.getElementById('addBtn');

        let currentPage = 1;
        const pageSize = 40;
        let allItems = [];

        function setStatus(msg, type = 'neutral') {
            statusMsg.className = 'status ' + type;
            statusText.textContent = msg;

            if (type === 'success') {
                addBtn.style.display = 'flex';
            } else {
                addBtn.style.display = 'none';
            }
        }

        // Initialize Supabase client (same URL + anon key you used)
        const supabase = window.supabase.createClient(
            "https://zpcqbxjmagxyrahcdgsp.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3FieGptYWd4eXJhaGNkZ3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTUwMDExNzAsImV4cCI6MjAzMDU3NzE3MH0.M9EfEMJPISponRYI8hzvIRt3iY-rZGu7y1AvXwgeGKM"
        );


        async function loadItemsForBrand() {
            try {
                setStatus('Connecting...', 'neutral');

                // get session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) {
                    console.error(sessionError);
                    setStatus('Unable to connect: ' + sessionError.message, 'error');
                    return;
                }
                if (!session) {
                    setStatus('No active session found. Please sign in.', 'error');
                    content.innerHTML = '<div class="empty">You must be signed in to view items for your brand.</div>';
                    return;
                }

                const userId = session.user.id;
                setStatus('Loading profile...', 'neutral');

                // fetch profile to get associated_brand
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('associated_brand')
                    .eq('id', userId)
                    .single();

                if (profileError) {
                    console.error(profileError);
                    setStatus('Could not load profile: ' + profileError.message, 'error');
                    return;
                }
                if (!profile || !profile.associated_brand) {
                    setStatus('No associated brand set on profile.', 'error');
                    content.innerHTML = '<div class="empty">Your profile does not have an associated_brand. Please set it first.</div>';
                    return;
                }

                const { data: brandData, error: brandError } = await supabase
                    .from('marque')
                    .select('marqueName, marqueImage')
                    .eq('marqueId', profile.associated_brand)
                    .single();

                if (brandError || !brandData) {
                    setStatus("Failed to get brand name.", "error");
                    return;
                }
                // Change this part in your loadItemsForBrand()
                welcomeText.innerHTML = `Welcome to Looker, ${brandData.marqueName}!
                    <img src="${brandData.marqueImage}" style="height: 40px; width: auto;">`;

                const brand = profile.associated_brand;

                setStatus('Fetching items...', 'neutral');

                // fetch items for the brand
                const { data: items, error: itemsError } = await supabase
                    .from('item')
                    .select('itemId, name, description, numberOfHearts, numberOfGems, photo, created_at')
                    .eq('marqueForeign', brand)
                    .order('created_at', { ascending: false });

                if (itemsError) {
                    console.error(itemsError);
                    setStatus('Error loading items: ' + itemsError.message, 'error');
                    content.innerHTML = '<div class="empty">Error loading items.</div>';
                    return;
                }

                if (!items || items.length === 0) {
                    setStatus('No items found for this brand.', 'neutral');
                    content.innerHTML = '<div class="empty">No items found for brand <strong>' + brand + '</strong>.</div>';
                    return;
                }

                allItems = items;

                const removeBtn = document.getElementById('removeBtn');
                const editBtn = document.getElementById('editBtn');

                function updateButtonsState() {
                    const checkedCount = document.querySelectorAll('.itemCheckbox:checked').length;

                    removeBtn.style.opacity = checkedCount >= 1 ? '1' : '0.5';
                    removeBtn.style.pointerEvents = checkedCount >= 1 ? 'auto' : 'none';
                    removeBtn.style.backgroundColor = checkedCount >= 1 ? '#333' : '#555';

                    editBtn.style.opacity = checkedCount === 1 ? '1' : '0.5';
                    editBtn.style.pointerEvents = checkedCount === 1 ? 'auto' : 'none';
                    editBtn.style.backgroundColor = checkedCount === 1 ? '#333' : '#555';
                }

                function renderTable(page) {
                    const start = (page - 1) * pageSize;
                    const end = start + pageSize;
                    const pageItems = allItems.slice(start, end);

                    const table = document.createElement('table');
                    table.className = 'items-table';

                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th> </th>
                            <th> </th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th class="center">Hearts</th>
                            <th class="center">Gems</th>
                        </tr>`;

                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');

                    pageItems.forEach(it => {
                        const tr = document.createElement('tr');

                        // Checkbox cell
                        const tdCheck = document.createElement('td');
                        const checkbox = document.createElement('input');
                        checkbox.dataset.id = it.itemId; // store item id in checkbox
                        checkbox.type = 'checkbox';
                        checkbox.style.appearance = 'none';
                        checkbox.style.width = '16px';
                        checkbox.style.height = '16px';
                        checkbox.style.border = '2px solid white';
                        checkbox.style.borderRadius = '4px';
                        checkbox.style.background = 'transparent';
                        checkbox.style.cursor = 'pointer';
                        checkbox.addEventListener('change', function () {
                            this.style.background = this.checked ? 'white' : 'transparent';
                        });
                        checkbox.className = 'itemCheckbox';
                        tdCheck.appendChild(checkbox);
                        tr.appendChild(tdCheck);

                        // Thumbnail
                        const tdThumb = document.createElement('td');
                        if (it.photo) {
                            const img = document.createElement('img');
                            img.src = it.photo;
                            img.alt = it.name || 'item photo';
                            img.style.width = '25px';
                            img.style.height = '25px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '2px';
                            tdThumb.appendChild(img);
                        } else {
                            tdThumb.textContent = '—';
                        }
                        tr.appendChild(tdThumb);

                        // Name
                        const tdName = document.createElement('td');
                        const nameSpan = document.createElement('div');
                        nameSpan.className = 'item-name';
                        nameSpan.textContent = it.name ?? '(no name)';
                        if (it.name) nameSpan.title = it.name;
                        tdName.appendChild(nameSpan);
                        tr.appendChild(tdName);

                        // Description
                        const tdDesc = document.createElement('td');
                        const descSpan = document.createElement('div');
                        descSpan.className = 'item-desc';
                        const rawDesc = it.description ?? '';
                        if (rawDesc) descSpan.title = rawDesc;
                        let truncated = rawDesc.slice(0, 40);
                        if (rawDesc.length > 40) truncated += '…';
                        descSpan.textContent = truncated;
                        tdDesc.appendChild(descSpan);
                        tr.appendChild(tdDesc);

                        // Date
                        const tdDate = document.createElement('td');
                        if (it.created_at) {
                            const dateObj = new Date(it.created_at);
                            const localTime = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const localDate = dateObj.toLocaleDateString([], { day: '2-digit', month: '2-digit', year: 'numeric' });
                            tdDate.textContent = `${localTime}, ${localDate}`;
                        } else {
                            tdDate.textContent = '—';
                        }
                        tr.appendChild(tdDate);

                        // Hearts
                        const tdHearts = document.createElement('td');
                        tdHearts.className = 'center';
                        tdHearts.textContent = it.numberOfHearts != null ? it.numberOfHearts : '0';
                        tr.appendChild(tdHearts);

                        // Gems
                        const tdGems = document.createElement('td');
                        tdGems.className = 'center';
                        tdGems.textContent = it.numberOfGems != null ? it.numberOfGems : '0';
                        tr.appendChild(tdGems);

                        tbody.appendChild(tr);
                    });

                    table.appendChild(tbody);

                    // Pagination footer
                    const pagination = document.createElement('div');
                    pagination.className = 'pagination';
                    const rangeText = document.createElement('span');
                    rangeText.textContent = `${start + 1}-${Math.min(end, allItems.length)} of ${allItems.length}`;

                    const nav = document.createElement('div');
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = '←';
                    prevBtn.disabled = page === 1;
                    prevBtn.onclick = () => { currentPage--; renderTable(currentPage); };

                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = '→';
                    nextBtn.disabled = end >= allItems.length;
                    nextBtn.onclick = () => { currentPage++; renderTable(currentPage); };

                    nav.appendChild(prevBtn);
                    nav.appendChild(nextBtn);

                    pagination.appendChild(rangeText);
                    pagination.appendChild(nav);

                    content.innerHTML = '';
                    content.appendChild(table);
                    content.appendChild(pagination);

                    setStatus('Items loaded (' + allItems.length + ')', 'success');

                    // rebind checkbox listeners
                    const removeBtn = document.getElementById('removeBtn');
                    const editBtn = document.getElementById('editBtn');
                    function updateButtonsState() {
                        const checkedCount = document.querySelectorAll('.itemCheckbox:checked').length;
                        removeBtn.style.opacity = checkedCount >= 1 ? '1' : '0.5';
                        removeBtn.style.pointerEvents = checkedCount >= 1 ? 'auto' : 'none';
                        removeBtn.style.backgroundColor = checkedCount >= 1 ? '#333' : '#555';
                        editBtn.style.opacity = checkedCount === 1 ? '1' : '0.5';
                        editBtn.style.pointerEvents = checkedCount === 1 ? 'auto' : 'none';
                        editBtn.style.backgroundColor = checkedCount === 1 ? '#333' : '#555';
                    }
                    document.querySelectorAll('.itemCheckbox').forEach(cb =>
                        cb.addEventListener('change', updateButtonsState)
                    );
                    updateButtonsState(); // ✅ ensures buttons start in disabled state
                }

                renderTable(currentPage);

                document.querySelectorAll('.itemCheckbox').forEach(cb => cb.addEventListener('change', updateButtonsState));
            } catch (err) {
                console.error(err);
                setStatus('Unexpected error: ' + (err.message || err), 'error');
                content.innerHTML = '<div class="empty">Unexpected error occurred. Check console for details.</div>';
            }
        }

        // Run on load
        (function () {
            loadItemsForBrand();
        })();

        addBtn.addEventListener('click', () => {
            window.location.href = 'add';
        });

        removeBtn.onclick = async () => {
            const selectedIds = Array.from(document.querySelectorAll('.itemCheckbox:checked'))
                .map(cb => cb.dataset.id);

            if (selectedIds.length === 0) return;

            console.log('selectedIds: ', selectedIds);

            if (!confirm(`Delete ${selectedIds.length} item(s)? This cannot be undone.`)) return;

            setStatus('Deleting...', 'neutral');

            const { error } = await supabase
                .from('item')
                .delete()
                .in('itemId', selectedIds); // changed to itemId

            if (error) {
                console.error(error);
                setStatus('Error deleting items: ' + error.message, 'error');
                return;
            }

            await loadItemsForBrand();
            setStatus(`Deleted ${selectedIds.length} item(s).`, 'success');
        };

        editBtn.addEventListener('click', () => {
            const selectedCheckbox = document.querySelector('.itemCheckbox:checked');
            if (!selectedCheckbox) {
                alert('Please select one item to edit.');
                return;
            }
            const itemId = selectedCheckbox.dataset.id;
            window.location.href = `edit.html?itemId=${itemId}`;
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                setStatus("Error signing out: " + error.message, "error");
                return;
            }
            window.location.href = 'login';
        });
    </script>
</body>

</html>