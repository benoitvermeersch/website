<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#fecd08">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="default">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: linear-gradient(135deg, #fecd08 10%, #49b95a 90%);
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: 100% 100%;
            margin: 0;
            padding: 0;
        }

        .container {
            background-color: #252525;
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 55px auto;
            padding: 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        input,
        button {
            width: 100%;
            box-sizing: border-box;
        }

        input {
            padding: 10px;
            margin: 8px 0;
            font-size: 16px;
            background-color: #333;
            color: white;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding-right: 40px;
        }

        .eye-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        button {
            padding: 12px;
            background-color: #49b95a;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .status {
            margin-top: 10px;
            font-weight: normal;
            color: white;
        }

        .status.error {
            color: red;
        }

        .status.success {
            color: green;
        }

        .status.neutral {
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Looker for Businesses</h1>
        <h2>Login</h2>

        <div class="status" id="statusMsg">Connecting...</div>

        <input type="email" id="email" placeholder="Email" required>

        <div class="input-wrapper">
            <input type="password" id="password" placeholder="Password" required>
            <img src="../images/hidden.svg" class="eye-icon" id="togglePassword">
        </div>

        <button id="loginBtn" style="margin-top:10px;">Login</button>

        <p id="forgotPasswordLink" style="color:#49b95a;cursor:pointer;margin-top:10px;text-decoration:underline;">
            Forgot password?
        </p>

        <div id="forgotPasswordSection" style="display:none;margin-top:5px;margin-bottom:15px;">
            <input type="email" id="forgotEmail" placeholder="Enter the email linked to your account">
            <div class="status" id="forgotStatus"></div>
            <button id="sendResetBtn" style="margin-top:8px;">Send reset link</button>
        </div>

        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
        <script>
            const statusMsg = document.getElementById('statusMsg');

            function setStatus(message, type = 'neutral') {
                statusMsg.textContent = message;
                statusMsg.className = 'status ' + type;
            }

            setStatus("Connecting...", "neutral");

            const supabase = window.supabase.createClient(
                "https://zpcqbxjmagxyrahcdgsp.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3FieGptYWd4eXJhaGNkZ3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTUwMDExNzAsImV4cCI6MjAzMDU3NzE3MH0.M9EfEMJPISponRYI8hzvIRt3iY-rZGu7y1AvXwgeGKM"
            );

            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');

            const togglePasswordIcon = document.getElementById('togglePassword');
            let isPasswordVisible = false;

            togglePasswordIcon.addEventListener('click', () => {
                isPasswordVisible = !isPasswordVisible;
                passwordInput.type = isPasswordVisible ? 'text' : 'password';
                togglePasswordIcon.src = isPasswordVisible ? '../images/shown.svg' : '../images/hidden.svg';
            });

            setStatus("Ready to log in.", "neutral");

            loginBtn.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;

                if (!email || !password) {
                    setStatus("Please enter both email and password.", "error");
                    return;
                }

                setStatus("Logging in...", "neutral");

                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (authError) {
                    setStatus("Login failed: " + authError.message, "error");
                    return;
                }

                const userId = authData.user.id;

                const { data: userData, error: fetchError } = await supabase
                    .from('profiles')
                    .select('role')
                    .eq('id', userId)
                    .single();

                if (fetchError) {
                    setStatus("Failed to fetch user role: " + fetchError.message, "error");
                    return;
                }

                if (userData.role !== 'company') {
                    setStatus("Access denied: Not a business account.", "error");
                    await supabase.auth.signOut();
                } else {
                    setStatus("Login successful. Welcome!", "success");
                    window.location.href = "home";
                }
            });

            // Trigger login on Enter key
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    loginBtn.click();
                }
            });

            function setForgotStatus(message, type = 'neutral') {
                forgotStatus.textContent = message;
                forgotStatus.className = 'status ' + type;
            }

            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            const forgotPasswordSection = document.getElementById('forgotPasswordSection');
            const forgotEmailInput = document.getElementById('forgotEmail');
            const forgotStatus = document.getElementById('forgotStatus');
            const sendResetBtn = document.getElementById('sendResetBtn');

            forgotPasswordLink.addEventListener('click', () => {
                forgotPasswordSection.style.display = forgotPasswordSection.style.display === 'none' ? 'block' : 'none';
            });

            let resetCooldown = false;
            let resetTimer;

            sendResetBtn.addEventListener('click', async () => {
                if (resetCooldown) {
                    setForgotStatus(`Please wait before trying again.`, "error");
                    return;
                }

                const email = forgotEmailInput.value.trim();
                if (!email) {
                    setForgotStatus("Please enter your email address.", "error");
                    return;
                }

                setForgotStatus("Sending reset link...", "neutral");

                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: 'acme://reset-password'
                });

                if (error) {
                    setForgotStatus("Error: " + error.message, "error");
                } else {
                    setForgotStatus("Password reset email sent successfully.", "success");

                    // Start cooldown
                    resetCooldown = true;
                    sendResetBtn.disabled = true;
                    sendResetBtn.style.backgroundColor = "#888"; // greyed out
                    let secondsLeft = 60;
                    sendResetBtn.textContent = `Send reset link (${secondsLeft}s)`;

                    resetTimer = setInterval(() => {
                        secondsLeft--;
                        sendResetBtn.textContent = `Send reset link (${secondsLeft}s)`;
                        if (secondsLeft <= 0) {
                            clearInterval(resetTimer);
                            resetCooldown = false;
                            sendResetBtn.disabled = false;
                            sendResetBtn.style.backgroundColor = "#49b95a";
                            sendResetBtn.textContent = "Send reset link";
                        }
                    }, 1000);
                }
            });
        </script>
    </div>
</body>

</html>