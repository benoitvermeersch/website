<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: linear-gradient(135deg, #fecd08 10%, #49b95a 90%);
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: 100% 100%;
            margin: 0;
            padding: 0;
        }

        .container {
            background-color: #252525;
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 55px auto;
            padding: 20px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        input,
        button {
            width: 100%;
            box-sizing: border-box;
        }

        input {
            padding: 10px;
            margin: 8px 0;
            font-size: 16px;
            background-color: #333;
            color: white;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding-right: 40px;
        }

        .eye-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        button {
            padding: 12px;
            background-color: #49b95a;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .status {
            margin-top: 10px;
            font-weight: normal;
            color: white;
        }

        .status.error {
            color: red;
        }

        .status.success {
            color: green;
        }

        .status.neutral {
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Looker</h1>
        <h2>Reset your password</h2>

        <div class="input-wrapper">
            <input type="password" id="newPassword" placeholder="Enter new password" required>
            <img src="images/hidden.svg" class="eye-icon" id="toggleNewPassword">
        </div>

        <div class="input-wrapper">
            <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
            <img src="images/hidden.svg" class="eye-icon" id="toggleConfirmPassword">
        </div>

        <button id="resetBtn">Reset password</button>

        <div class="status" id="statusMsg">Connecting...</div>

        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
        <script>
            const statusMsg = document.getElementById('statusMsg');

            function setStatus(message, type = 'neutral') {
                statusMsg.textContent = message;
                statusMsg.className = 'status ' + type;
            }

            setStatus("Connecting...", "neutral");

            // Create Supabase client
            const supabase = window.supabase.createClient(
                "https://zpcqbxjmagxyrahcdgsp.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpwY3FieGptYWd4eXJhaGNkZ3NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTUwMDExNzAsImV4cCI6MjAzMDU3NzE3MH0.M9EfEMJPISponRYI8hzvIRt3iY-rZGu7y1AvXwgeGKM"
            );

            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const resetBtn = document.getElementById('resetBtn');

            // Initial connection success
            setStatus("Established connection. Waiting for input...", "success");

            function addPasswordToggle(input, icon) {
                let isVisible = false;

                icon.addEventListener('click', () => {
                    isVisible = !isVisible;

                    if (isVisible) {
                        input.type = 'text';
                        icon.src = 'images/shown.svg';
                    } else {
                        input.type = 'password';
                        icon.src = 'images/hidden.svg';
                    }
                });
            }

            const toggleNew = document.getElementById('toggleNewPassword');
            const toggleConfirm = document.getElementById('toggleConfirmPassword');

            addPasswordToggle(newPasswordInput, toggleNew);
            addPasswordToggle(confirmPasswordInput, toggleConfirm);

            // Track password inputs
            function validatePasswords() {
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (!newPassword || !confirmPassword) {
                    setStatus("Waiting for both inputs...", "neutral");
                    return false;
                }

                if (newPassword !== confirmPassword) {
                    setStatus("Passwords do not match!", "error");
                    return false;
                }

                if (newPassword.length < 6) {
                    setStatus("Password must contain at least 6 characters.", "error");
                    return false;
                }

                setStatus("Passwords match! Ready to reset.", "success");
                return true;
            }

            newPasswordInput.addEventListener('input', validatePasswords);
            confirmPasswordInput.addEventListener('input', validatePasswords);

            // Handle Reset Password
            resetBtn.addEventListener('click', async () => {
                if (!validatePasswords()) return;

                setStatus("Processing...", "neutral");

                // Extract the access token from the URL hash
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const token = hashParams.get('token_hash');

                if (!token) {
                    setStatus("Error: Missing token in URL.", "error");
                    return;
                }

                const newPassword = newPasswordInput.value;

                const { data: verifyData, error: verifyError } = await supabase.auth.verifyOtp({
                    token_hash: token,
                    type: 'email'
                });

                if (verifyError) {
                    setStatus("Error verifying token: " + verifyError.message, "error");
                    return;
                }

                setStatus("Token verified successfully. Updating password...", "success");

                // Update the user password using the session token
                const { data: updateData, error: updateError } = await supabase.auth.updateUser(
                    { password: newPassword }
                );

                if (updateError) {
                    setStatus("Error resetting password: " + updateError.message, "error");
                } else {
                    setStatus("Password successfully reset!", "success");
                }
            });
        </script>
    </div>
</body>

</html>